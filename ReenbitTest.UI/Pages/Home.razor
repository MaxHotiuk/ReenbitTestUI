@page "/"
@page "/{ChatRoomId:int?}"
@using ReenbitTest.UI.Interfaces
@using ReenbitTest.UI.Models
@using System.Text.Json
@using MudBlazor
@inject IJSRuntime JSRuntime
@inject IChatService ChatService
@inject IChatHubService ChatHubService
@inject IAuthService AuthService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject ReenbitTest.UI.Services.NavbarEventService NavbarEventService
@implements IAsyncDisposable

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4 px-0">
    <MudPaper Class="d-flex flex-row h-100" Style="height: calc(100vh - 104px);" Elevation="0">
        <!-- Chat Area -->
        <MudPaper Elevation="0" Class="flex-grow-1 d-flex flex-column" Style="position: relative;">
            @if (_selectedChatRoom == null)
            {
                <MudPaper Class="d-flex justify-center align-center" Style="height: 100%;" Elevation="0">
                    <MudText Typo="Typo.h6" Class="mud-text-secondary">Select a chat or create a new one</MudText>
                </MudPaper>
            }
            else
            {
                <MudPaper Elevation="0" Class="d-flex flex-column h-100">
                    <!-- Chat Header - Fixed to the top -->
                    <MudAppBar Color="Color.Primary" Fixed="true" Dense="false" Class="flex-row align-center px-4">
                        <!-- Mobile menu drawer button -->
                        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" 
                            OnClick="@ToggleNavbar" 
                            Class="mr-3 d-md-none" />
                        
                        <div class="d-flex flex-column flex-grow-1">
                            <MudText Typo="Typo.h6">@_selectedChatRoom.Name</MudText>
                
                            @if (_typingUsers.Any())
                            {
                                <MudText Typo="Typo.caption">
                                    @GetTypingText()
                                </MudText>
                            }
                            else
                            {
                                <MudText Typo="Typo.caption">
                                    @(_selectedChatRoom.Users.Count) members
                                </MudText>
                            }
                        </div>
                    </MudAppBar>
                    
                    <!-- Spacer to account for fixed AppBar -->
                    <div style="height: 64px;"></div>

                    <!-- Chat Messages -->
                    <MudPaper id="messages-container" Elevation="0" Class="flex-grow-1 overflow-y-auto pa-3" @ref="_messagesContainerRef" Style="margin-bottom: 76px;">
                        @if (_isLoadingMessages)
                        {
                            <MudProgressCircular Color="Color.Secondary" Size="Size.Medium" Indeterminate="true" Class="ma-auto d-flex" />
                        }
                        else if (_messages.Count == 0)
                        {
                            <MudText Align="Align.Center" Class="mud-text-secondary my-4">No messages yet</MudText>
                        }
                        else
                        {
                            <div class="d-flex flex-column">
                                @{
                                    var currentDate = DateTime.MinValue;
                                    var groupedMessages = _messages.OrderBy(m => m.SentAt).ToList();

                                    for (int i = 0; i < groupedMessages.Count; i++)
                                    {
                                        var message = groupedMessages[i];
                                        var isFirstInGroup = i == 0 || groupedMessages[i - 1].SenderUserName != message.SenderUserName;
                                        
                                        <div class="d-flex @(message.IsCurrentUser ? "flex-row-reverse" : "flex-row")" style="margin-bottom: 8px;">
                                            @if (isFirstInGroup && !message.IsCurrentUser)
                                            {
                                                <MudAvatar Color="Color.Secondary" Class="mr-2 mt-1" Size="Size.Small">
                                                    @message.SenderUserName[0]
                                                </MudAvatar>
                                            }
                                            else if (!message.IsCurrentUser)
                                            {
                                                <div style="width: 32px;"></div>
                                            }

                                            <div class="d-flex flex-column @(message.IsCurrentUser ? "align-end" : "align-start")" style="max-width: 75%;">
                                                <MudPaper Elevation="1" 
                                                        Class="@($"pa-3 rounded-lg position-relative {(message.IsCurrentUser ? "mud-theme-primary" : "mud-theme-tertiary")}")"
                                                        Style="min-width: 120px;">
                                                    
                                                    <!-- User name inside message -->
                                                    <MudText Typo="Typo.caption" Color="@(message.IsCurrentUser ? Color.Default : Color.Primary)" Class="mb-1 font-weight-bold">
                                                        @(message.IsCurrentUser ? "" : message.SenderFullName)
                                                    </MudText>
                                                    
                                                    <!-- Message content -->
                                                    <MudText>@message.Content</MudText>
                                                    
                                                    <!-- Fixed: Time and sentiment badge positioned correctly -->
                                                    <div class="d-flex justify-end align-center mt-1">
                                                        <MudText Typo="Typo.caption" Class="mud-text-secondary mr-1">
                                                            @message.SentAt.ToString("t")
                                                        </MudText>
                                                        
                                                        @if (!string.IsNullOrEmpty(message.SentimentLabel))
                                                        {
                                                            <MudIcon Icon="@GetSentimentIcon(message.SentimentLabel)" 
                                                                    Color="@GetSentimentColor(message.SentimentLabel)" 
                                                                    Size="Size.Small" />
                                                        }
                                                    </div>
                                                </MudPaper>
                                            </div>
                                        </div>
                                    }
                                }
                            </div>
                        }
                    </MudPaper>

                    <!-- Message Input - Fixed to the bottom -->
                    <MudAppBar Color="Color.Primary" Elevation="3" Class="py-2 px-3" Bottom Fixed="true">
                        <MudGrid Spacing="1" Class="ma-0 pa-0">
                            <MudItem xs="11">
                                <MudTextField @ref="_messageInputRef"
                                    @bind-Value="_newMessage"
                                    Placeholder="Type your message..."
                                    Variant="Variant.Outlined"
                                    Immediate="true"
                                    OnKeyDown="HandleKeyDown"
                                    TextChanged="HandleInputChange"
                                    Disabled="@(!ChatHubService.IsConnected || _selectedChatRoom == null)"
                                    FullWidth="true" />
                            </MudItem>
                            <MudItem xs="1" Class="d-flex align-center justify-center">
                                <MudIconButton Color="Color.Primary"
                                             Size="Size.Medium"
                                             Icon="@Icons.Material.Filled.Send"
                                             OnClick="SendMessage"
                                             Disabled="@(string.IsNullOrWhiteSpace(_newMessage) || !ChatHubService.IsConnected || _selectedChatRoom == null)" />
                            </MudItem>
                        </MudGrid>
                    </MudAppBar>
                </MudPaper>
            }
        </MudPaper>
    </MudPaper>
</MudContainer>

@code {
    [Parameter]
    public int? ChatRoomId { get; set; }

    private ChatRoom? _selectedChatRoom;
    private List<Message> _messages = new();
    private Dictionary<string, string> _typingUsers = new();
    private string _newMessage = "";
    private bool _isLoadingMessages = false;
    private bool _isUserTyping = false;
    private DateTime _lastTypingNotification = DateTime.MinValue;
    private System.Threading.Timer? _typingTimer;
    private bool _connectionInitialized = false;
    private MudTextField<string>? _messageInputRef;
    private MudPaper? _messagesContainerRef;
    private int _currentPage = 1;
    private const int PageSize = 20;
    private bool _allMessagesLoaded = false;

    protected override async Task OnInitializedAsync()
    {
        if (ChatRoomId.HasValue)
        {
            await LoadChatRoom(ChatRoomId.Value);
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (ChatRoomId.HasValue && (_selectedChatRoom == null || _selectedChatRoom.Id != ChatRoomId.Value))
        {
            await LoadChatRoom(ChatRoomId.Value);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && AuthService.IsAuthenticated && !_connectionInitialized)
        {
            await InitializeHubConnection();
        }

        await ScrollToBottomAsync();
    }

    private async Task InitializeHubConnection()
    {
        try
        {
            var token = await AuthService.GetTokenAsync();
            if (string.IsNullOrEmpty(token))
                return;

            await ChatHubService.StartConnectionAsync(token);
            
            ChatHubService.OnReceiveMessage += HandleReceiveMessage;
            ChatHubService.OnLoadRecentMessages += HandleLoadRecentMessages;
            ChatHubService.OnUserTyping += HandleUserTyping;
            ChatHubService.OnUserStoppedTyping += HandleUserStoppedTyping;
            ChatHubService.OnUserJoined += HandleUserJoined;
            ChatHubService.OnUserLeft += HandleUserLeft;
            ChatHubService.OnError += HandleError;

            _connectionInitialized = true;

            // Join the chat room if already selected
            if (_selectedChatRoom != null)
            {
                await ChatHubService.JoinChatRoomAsync(_selectedChatRoom.Id);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Connection error: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadChatRoom(int chatRoomId)
    {
        try
        {
            _messages.Clear();
            _currentPage = 1;
            _allMessagesLoaded = false;
            _selectedChatRoom = await ChatService.GetChatRoomAsync(chatRoomId);
            await LoadMessages();

            if (_connectionInitialized)
            {
                await ChatHubService.JoinChatRoomAsync(chatRoomId);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading chat: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadMessages()
    {
        if (_selectedChatRoom == null || _allMessagesLoaded)
            return;

        try
        {
            _isLoadingMessages = true;
            var messages = await ChatService.GetMessagesForChatRoomAsync(_selectedChatRoom.Id, _currentPage, PageSize);
            
            if (messages.Count == 0 || messages.Count < PageSize)
            {
                _allMessagesLoaded = true;
            }

            _messages.AddRange(messages);
            _currentPage++;
            _isLoadingMessages = false;
        }
        catch (Exception ex)
        {
            _isLoadingMessages = false;
            Snackbar.Add($"Error loading messages: {ex.Message}", Severity.Error);
        }
    }

    private async Task HandleChatSelected(int chatRoomId)
    {
        if (_selectedChatRoom?.Id == chatRoomId)
            return;

        // Leave current chat room if any
        if (_selectedChatRoom != null && ChatHubService.IsConnected)
        {
            await ChatHubService.LeaveChatRoomAsync(_selectedChatRoom.Id);
        }

        await LoadChatRoom(chatRoomId);
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(_newMessage) || _selectedChatRoom == null || !ChatHubService.IsConnected)
            return;

        try
        {
            var message = new CreateMessage
            {
                Content = _newMessage.Trim(),
                ChatRoomId = _selectedChatRoom.Id
            };

            await ChatHubService.SendMessageAsync(message);
            _newMessage = "";

            // Notify stopped typing
            await NotifyStoppedTypingAsync();
            
            // Focus the input field
            if (_messageInputRef != null) 
            {
                await _messageInputRef.FocusAsync();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error sending message: {ex.Message}", Severity.Error);
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs args)
    {
        if (args.Key == "Enter" && !args.ShiftKey)
        {
            await SendMessage();
        }
    }

    private async Task HandleInputChange(string value)
    {
        if (_selectedChatRoom == null || !ChatHubService.IsConnected)
            return;

        var now = DateTime.Now;
        if (!_isUserTyping || (now - _lastTypingNotification).TotalSeconds > 2)
        {
            _isUserTyping = true;
            _lastTypingNotification = now;
            
            try
            {
                Console.WriteLine($"User typing in chat room: {_selectedChatRoom.Id}");
                await ChatHubService.NotifyUserTypingAsync(_selectedChatRoom.Id);
                
                // Reset typing timer
                _typingTimer?.Dispose();
                _typingTimer = new System.Threading.Timer(
                    async _ => await InvokeAsync(NotifyStoppedTypingAsync), 
                    null, 
                    3000, 
                    Timeout.Infinite);
            }
            catch (Exception ex)
            {
                // Log but don't show to user as it's not critical
                Console.WriteLine($"Error in typing notification: {ex.Message}");
            }
        }
    }

    private async Task NotifyStoppedTypingAsync()
    {
        if (_isUserTyping && _selectedChatRoom != null && ChatHubService.IsConnected)
        {
            _isUserTyping = false;
            
            try
            {
                Console.WriteLine($"User stopped typing in chat room: {_selectedChatRoom.Id}");
                await ChatHubService.NotifyUserStoppedTypingAsync(_selectedChatRoom.Id);
            }
            catch (Exception ex)
            {
                // Log but don't show to user as it's not critical
                Console.WriteLine($"Error in stopped typing notification: {ex.Message}");
            }
        }
    }

    private void HandleReceiveMessage(Message message)
    {
        if (_selectedChatRoom?.Id != message.ChatRoomId)
            return;

        // Add message to the list if not already present
        if (!_messages.Any(m => m.Id == message.Id))
        {
            // Set IsCurrentUser flag if the message is from the current user
            if (message.SenderFullName == AuthService.CurrentUser?.FullName)
            {
                message.IsCurrentUser = true;
            }
            
            _messages.Add(message);
            InvokeAsync(StateHasChanged);
            InvokeAsync(ScrollToBottomAsync);
        }
    }

    private void HandleLoadRecentMessages(List<Message> messages)
    {
        if (_selectedChatRoom == null || messages.Count == 0)
            return;

        var chatRoomId = messages.First().ChatRoomId;
        if (_selectedChatRoom.Id != chatRoomId)
            return;

        // Add messages that aren't already in the list
        foreach (var message in messages)
        {
            if (!_messages.Any(m => m.Id == message.Id))
            {
                _messages.Add(message);
            }
        }

        InvokeAsync(StateHasChanged);
        InvokeAsync(ScrollToBottomAsync);
    }

    private void HandleUserTyping(UserTypingInfo typingInfo)
    {
        if (typingInfo.UserId == AuthService.CurrentUser?.Id || _selectedChatRoom?.Id != typingInfo.ChatRoomId)
            return;

        _typingUsers[typingInfo.UserId] = typingInfo.UserName;
        StateHasChanged();
    }

    private void HandleUserStoppedTyping(UserTypingInfo typingInfo)
    {
        if (_typingUsers.ContainsKey(typingInfo.UserId) && _selectedChatRoom?.Id == typingInfo.ChatRoomId)
        {
            _typingUsers.Remove(typingInfo.UserId);
            StateHasChanged();
        }
    }

    private void HandleUserJoined(int chatRoomId, string userId, string userName)
    {
        if (_selectedChatRoom?.Id != chatRoomId || userId == AuthService.CurrentUser?.Id)
            return;

        Snackbar.Add($"{userName} joined the chat", Severity.Info);
    }

    private void HandleUserLeft(int chatRoomId, string userId, string userName)
    {
        if (_selectedChatRoom?.Id != chatRoomId || userId == AuthService.CurrentUser?.Id)
            return;

        Snackbar.Add($"{userName} left the chat", Severity.Info);
    }

    private void HandleError(string error)
    {
        Snackbar.Add(error, Severity.Error);
    }

    private async Task ScrollToBottomAsync()
    {
        if (_messagesContainerRef != null)
        {
            // Small delay to ensure rendering is complete
            await Task.Delay(50); 
            
            await JSRuntime.InvokeVoidAsync("window.scrollFunctions.scrollToBottom");
        }
    }

    private string GetTypingText()
    {
        if (_typingUsers.Count == 0)
            return "";
        else if (_typingUsers.Count == 1)
            return $"{_typingUsers.Values.First()} is typing...";
        else if (_typingUsers.Count == 2)
            return $"{string.Join(" and ", _typingUsers.Values)} are typing...";
        else
            return "Several people are typing...";
    }

    private string GetSentimentIcon(string? sentiment)
    {
        return sentiment?.ToLower() switch
        {
            "positive" => Icons.Material.Filled.SentimentVerySatisfied,
            "negative" => Icons.Material.Filled.SentimentVeryDissatisfied,
            "neutral" => Icons.Material.Filled.SentimentNeutral,
            _ => Icons.Material.Filled.SentimentNeutral
        };
    }

    private Color GetSentimentColor(string? sentiment)
    {
        return sentiment?.ToLower() switch
        {
            "positive" => Color.Default,
            "negative" => Color.Error,
            "neutral" => Color.Secondary,
            _ => Color.Secondary
        };
    }

    private void ShowChatMembers()
    {
        if (_selectedChatRoom == null)
            return;

        // Here you'd show a dialog with the chat members
        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            CloseButton = true,
            MaxWidth = MaxWidth.ExtraSmall
        };

        var parameters = new DialogParameters
        {
            ["ChatRoom"] = _selectedChatRoom
        };

        // Assuming you have a MembersDialog component
        // await DialogService.ShowAsync<MembersDialog>("Chat Members", parameters, options);
    }

    private void AddUserToChatDialog()
    {
        if (_selectedChatRoom == null)
            return;

        // Here you'd show a dialog to add users
        // Similar to ShowChatMembers
    }

    private async Task LeaveChatRoom()
    {
        if (_selectedChatRoom == null || !ChatHubService.IsConnected)
            return;

        try
        {
            var result = await ChatService.RemoveUserFromChatRoomAsync(_selectedChatRoom.Id, AuthService.CurrentUser!.Id);
            if (result)
            {
                await ChatHubService.LeaveChatRoomAsync(_selectedChatRoom.Id);
                _selectedChatRoom = null;
                _messages.Clear();
                NavigationManager.NavigateTo("/");
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error leaving chat: {ex.Message}", Severity.Error);
        }
    }

    public async ValueTask DisposeAsync()
    {
        _typingTimer?.Dispose();
        
        if (_connectionInitialized)
        {
            // Unregister event handlers
            ChatHubService.OnReceiveMessage -= HandleReceiveMessage;
            ChatHubService.OnLoadRecentMessages -= HandleLoadRecentMessages;
            ChatHubService.OnUserTyping -= HandleUserTyping;
            ChatHubService.OnUserStoppedTyping -= HandleUserStoppedTyping;
            ChatHubService.OnUserJoined -= HandleUserJoined;
            ChatHubService.OnUserLeft -= HandleUserLeft;
            ChatHubService.OnError -= HandleError;
            
            // Leave current chat room if any
            if (_selectedChatRoom != null)
            {
                await ChatHubService.LeaveChatRoomAsync(_selectedChatRoom.Id);
            }
        }
    }

    private void ToggleNavbar()
    {
        NavbarEventService.ToggleNavbar();
    }
}